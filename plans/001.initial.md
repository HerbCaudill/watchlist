# Watchlist App — Implementation Plan

## Context

Build a local-first app for tracking movies and TV shows to watch. The UI has a search bar,
Discover/Watchlist tabs, and a Movies/TV shows toggle. The user searches by title, sees matches,
and adds items to their watchlist with one tap. Tapping a card opens a detail view with plot,
full ratings, and trailer.

Uses DXOS for local-first persistence, Effect Schema for API data decoding, and reuses movie
data services and normalized score logic from vose-flix. Starting with presentational components
in Storybook.

## Phase 1: Storybook + presentational components

### 1a. Install and configure Storybook

Add devDependencies: `@storybook/react`, `@storybook/react-vite`, `@storybook/addon-essentials`,
`@storybook/addon-interactions`, `storybook`

Create:

- `.storybook/main.ts` — stories glob: `../src/**/*.stories.tsx`
- `.storybook/preview.ts` — imports `../src/index.css`
- Scripts: `storybook`, `build:storybook`

### 1b. Shared types

Create `src/types.ts`:

```ts
type MediaType = "movie" | "tv"
type Tab = "discover" | "watchlist"

interface Ratings {
  rottenTomatoes?: { critics: number; audience?: number }
  metacritic?: number
  imdb?: { score: number; votes: number }
}

interface MediaItem {
  id: string
  tmdbId: number
  title: string
  year?: number
  posterUrl?: string
  mediaType: MediaType
  overview?: string
  ratings: Ratings
  normalizedScore?: number | null
}
```

### 1c. Fixture data

Create `src/lib/fixtures.ts` — mock `MediaItem` objects for stories (movie, TV show, no poster,
no ratings, long title variants).

### 1d. Components

Many of these components can be copied with minimal changes from ../vose-flix .

Each component in `src/components/`, stories in `src/components/stories/`.

| Component               | Props                                       | Notes                                         |
| ----------------------- | ------------------------------------------- | --------------------------------------------- |
| **ScoreBadge**          | `score: number, size?: "sm" \| "md"`        | Green ≥70, yellow ≥50, red <50                |
| **RatingDisplay**       | `label, value, score, subtext?`             | Single source (RT, IMDb, etc.)                |
| **RatingsBar**          | `ratings: Ratings`                          | Row of RatingDisplay                          |
| **PosterImage**         | `src?, alt, size?: "sm" \| "md" \| "lg"`    | 2:3 aspect, placeholder fallback              |
| **MediaCard**           | `item, onAction?, isOnWatchlist?`           | Poster + title + year + score + action button |
| **MediaDetail**         | `item, isOnWatchlist?, onAction?, onClose?` | Full detail: poster, plot, ratings, trailer   |
| **SearchBar**           | `value, onSubmit, onChange, onClear?`       | Enter to search, clear button                 |
| **TabBar**              | `activeTab, onTabChange`                    | Discover / Watchlist                          |
| **MediaToggle**         | `value, onChange`                           | Movies / TV shows                             |
| **SearchResults**       | `items, watchlistIds, onAdd?, isLoading?`   | Grid of MediaCards                            |
| **WatchlistView**       | `items, onRemove?, onSelect?`               | Grid of watchlist MediaCards                  |
| **DiscoverPlaceholder** | (none)                                      | "Coming soon" with icon                       |
| **AppShell**            | search/tab/toggle state + children          | Overall layout                                |

## Phase 2: Data layer with Effect Schema

### 2a. Install Effect

`pnpm add effect`

### 2b. TMDB search schema

`src/schema/TmdbSearchResult.ts` — Effect Schema decoding TMDB `/search/movie` and `/search/tv`
responses into `MediaItem[]`. Handles different field names (title vs name, release_date vs
first_air_date).

### 2c. OMDB enrichment schema

`src/schema/OmdbResult.ts` — Effect Schema decoding OMDB response into `Ratings`.

### 2d. Score calculation

`src/lib/calculateNormalizedScore.ts` — Port from vose-flix. Averages available scores
(RT critics, Metacritic, IMDb×10) on a 0–100 scale.

## Phase 3: API services

### 3a. Environment variables

`.env` (gitignored):

```
VITE_TMDB_API_KEY=...
VITE_OMDB_API_KEY=...
```

`.env.example` (committed):

```
VITE_TMDB_API_KEY=
VITE_OMDB_API_KEY=
```

### 3b. TMDB search

`src/lib/searchTmdb.ts` — searches `/search/movie` or `/search/tv`, decodes with Effect Schema,
returns `MediaItem[]`.

### 3c. OMDB enrichment

`src/lib/fetchOmdbData.ts` — fetches by title, decodes with Effect Schema, returns `Ratings`.

### 3d. TMDB trailer

`src/lib/fetchTmdbTrailer.ts` — port from vose-flix, returns YouTube video ID.

### 3e. Enrichment pipeline

`src/lib/enrichMediaItem.ts` — takes `MediaItem` from TMDB, fetches OMDB ratings + TMDB trailer,
calculates normalized score, returns enriched item.

## Phase 4: DXOS integration

### 4a. Install DXOS

```
pnpm add @dxos/config @dxos/echo @dxos/echo-schema @dxos/react-client @dxos/shell @dxos/util
pnpm add -D vite-plugin-wasm vite-plugin-top-level-await
```

### 4b. Echo schema

`src/schema/WatchlistItem.ts` — DXOS Echo schema using `S.Struct` + `Type.Obj`, storing
tmdbId, title, year, posterUrl, mediaType, overview, normalizedScore, addedAt.

### 4c. DXOS config + workers

- `src/config.ts` — config provider
- `src/shared-worker.ts` — SharedWorker
- `public/shell.html` + `src/shell.ts` — HALO identity shell
- `dx.yml` — DXOS runtime config

### 4d. Vite config updates

Add `wasm()`, `topLevelAwait()`, DXOS config plugin. Build target `esnext`.

### 4e. Bootstrap

Update `main.tsx` — wrap app in `<ClientProvider>` with types `[WatchlistItem]`.

### 4f. Hooks

`src/hooks/useWatchlist.ts` — uses `useSpace`, `useQuery(Filter.type(WatchlistItem))`.
Returns `{ items, add, remove, isOnWatchlist }`.

## Phase 5: Wire together

### 5a. Search hook

`src/hooks/useSearch.ts` — manages query state, calls `searchTmdb` on Enter, enriches results
with OMDB data. Returns `{ query, setQuery, search, results, isLoading }`.

### 5b. App.tsx

Stateful root: `useSearch`, `useWatchlist`, tab/toggle state. Renders `AppShell` with
appropriate content view based on active tab and search state.

### 5c. E2E tests

Playwright tests: search flow, add to watchlist, tab switching, media toggle.

## Verification

1. `pnpm storybook` — all stories render correctly
2. `pnpm test` — unit tests pass (score calculation, schema decoding)
3. `pnpm dev` — app loads, search works, watchlist persists across refresh
4. `pnpm test:pw` — E2E tests pass
5. `pnpm typecheck` — no type errors

## File tree (final)

```
.storybook/
  main.ts
  preview.ts
src/
  schema/
    WatchlistItem.ts
    TmdbSearchResult.ts
    OmdbResult.ts
  components/
    stories/
      ScoreBadge.stories.tsx
      RatingDisplay.stories.tsx
      RatingsBar.stories.tsx
      PosterImage.stories.tsx
      MediaCard.stories.tsx
      MediaDetail.stories.tsx
      SearchBar.stories.tsx
      TabBar.stories.tsx
      MediaToggle.stories.tsx
      SearchResults.stories.tsx
      WatchlistView.stories.tsx
      DiscoverPlaceholder.stories.tsx
      AppShell.stories.tsx
    ScoreBadge.tsx
    RatingDisplay.tsx
    RatingsBar.tsx
    PosterImage.tsx
    MediaCard.tsx
    MediaDetail.tsx
    SearchBar.tsx
    TabBar.tsx
    MediaToggle.tsx
    SearchResults.tsx
    WatchlistView.tsx
    DiscoverPlaceholder.tsx
    AppShell.tsx
  hooks/
    useWatchlist.ts
    useSearch.ts
  lib/
    utils.ts                    (existing)
    constants.ts
    fixtures.ts
    calculateNormalizedScore.ts
    searchTmdb.ts
    fetchOmdbData.ts
    fetchTmdbTrailer.ts
    enrichMediaItem.ts
  config.ts
  shared-worker.ts
  shell.ts
  types.ts
  App.tsx
  main.tsx
  index.css
.env
.env.example
dx.yml
```
